# 2장 아키텍처 개요

- 아키텍처
  - [네 개의 영역](#네-개의-영역)
  - [계층 구조 아키텍처](#계층-구조-아키텍처)
- DIP
  - [DIP](#DIP)
    - [DIP 주의 사항](#DIP-주의-사항)
    - [DIP와 아키텍처](#DIP와-아키텍처)
- 도메인 영역의 주요 구성요소
  - [도메인 영역의 주요 구성요소](#도메인-영역의-주요-구성요소)
    - [엔티티와 밸류](#엔티티와-밸류)
    - [애그리거트](#애그리거트)
    - [리포지토리](#리포지토리)
  - [요청 처리 흐름](#요청-처리-흐름)
- 인프라스트럭처
  - [인프라스트럭처 개요](#인프라스트럭처-개요)
- 모듈
  - [모듈 구성](#모듈-구성)

## 네 개의 영역

- 표현
  - 사용자 요청/응답 담당
  - 응용 영역이 필요로 하는 형식으로 변환해서 응용 영역에 전달한다.
  - 응용 영역의 응답을 HTTP 응답으로 변환해서 전송한다. 
- 응용
  - 로직을 직접 수행하기보다는 도메인 모델에 로직 수행을 위임한다.
  - 표현 계층의 요청에 대해 도메인간 협력하여 응답한다.
- 도메인
  - 도메인 모델을 구현한다.
  - 도메인의 핵심 로직을 담당한다.
- 인프라스트럭처
  - 구현 기술을 담당한다.
    - RDBMS, 메시징 큐, 그외 외부 시스템(결제, 메일...) 설정 
  - 논리적인 개념을 표현하기보다는 실제 구현을 다룬다.

도메인, 응용, 표현 영역은 구현 기술을 사용한 코드를 직접 만들지 않는다. 대신 인프라스트럭처 영역에서 제공하는 기능을 사용해서 필요한 기능을 개발한다.

## 계층 구조 아키텍처

도메인의 복잡도에 따라 응용과 도메인을 분리하기도 한다.

- 표현
- 응용
- 도메인
- 인프라스트럭처

상위 계층에서 하위 계층으로 의존만 존재한다. 하위 계층에서 상위 계층으로 의존하지 않는다.

- 상위 계층 -> 하위 계층
- 고수준 모듈 -> 저수준 모듈

엄격하게 적용하면 상위 계층은 바로 아래의 계층에만 의존하지만, 구현의 편리함을 위해 계층 구조를 유연하게 적용할 수 있다.

- 응용 -> 도메인
- 응용 -> 인프라스트럭처

중요한 핵심은 상위 계층에서 반드시 인프라스트럭처의 기능을 사용함으로 표현, 응용, 도메인 계층이 상세한 구현 기술을 다루는 인프라스트럭처 계층에 종속된다는 점이다.

인프라스트럭처에 의존하면 `테스트 어려움`, `기능 확장의 어려움` 이라는 두 가지 문제가 발생한다.

1. 테스트 어려움
   - 인프라스트럭처 계층과 의존적이면 단일 테스트하기 어렵다.
   - 단일 테스트를 진행하기 위해 인프라스트럭처의 기능이 완전하게 동작해야 함으로, Fixture 나 Fake 객체를 구현해야 한다.
2. 기능 확장의 어려움
   - 구현 방식을 변경하기 어렵다.
   - 인프라스트럭처 계층의 기능이 변경되면 의존된 도메인, 응용, 표현 계층의 변경이 필요하다.

## DIP

고수준의 모듈을 일반화하여 저수준의 모듈로 추출해야 한다.

- 고수준 모듈(상위 계층): 의미 있는 단일 기능 제공
- 저수준 모듈(하위 계층): 고수준 모듈의 기능을 구현하기 위한 실제 하위 구현 기능 제공
  - 인프라스트럭처 계층 모듈

고수준 모듈이 제대로 동작하려면 저수준 모듈을 사용해야 한다.

DIP는 이 문제를 해결하기 위해 저수준 모듈이 고수준 모듈에 의존하도록 바꾼다.

- 고수준 모듈을 구현하려면 저수준 모듈을 사용해야 한다.
- 반대로 저수준 모듈이 고수준 모듈에 의존하도록 하려면?
- 추상화 인터페이스를 확용해라.

인프라스트럭처 계층에 의존하는 계층은 추상화된 인터페이스를 의존하자.

저수준 모듈(인프라스트럭처 계층 모듈) 은 추상화된 언터페이스에 의존하여 직접적인 저수준 모듈 사용을 지양하여 인프라스트럭처 계층과의 결합도를 낮춰야 한다.

DIP 를 적용하면 저수준 모듈이 고수준 모듈에 의존하게 된다.

- 고수준 모듈이 저수준 모듈을 사용하려면 고수준 모듈이 저수준 모듈에 의존해야 한다.
- 반대로 저수준 모듈이 고수준 모듈에 의존한다고 해서 이를 DIP(Dependency Inversion Principle, 의존 역전 원칙)라고 부른다. 
- 저수준 모듈이 고수준 모듈에 의존되어야, 실제 구현 클래스 또는 실제 구현 대신 Stub 이나 Mock 과 같은 테스트 대용 객체를 이용해서 거의 모든 기능을 테스트 할 수 있다.

### DIP 주의 사항

DIP는 단순히 추상화 인터페이스를 추출하는 행위가 아니다.

- DIP의 핵심은 고수준 모듈이 저수준 모듈에 의존하지 않도록 하기 위함이다.
- 추상화 인터페이스는 인프라스트럭처 영역 관점이 아니라 **도메인 관점에서 도출해야한다.**
  - 도메인 규칙을 기준으로 추출한 인터페이스는 저수준 모듈이 아닌 고수준 모듈에 위치해야 한다.

### DIP와 아키텍처

인프라스트럭처 영역은 구현 기술을 다루는 저수준 모듈이다.

응용 영역과 도메인 영역은 고수준 모듈이다.

아키텍처 수준에서 DIP 를 적용하면 인프라스트럭쳐 영역이 응용 영역과 도메인 영역에 의존하는 구조가 된다.

- 인프라스트럭쳐 모듈 -> 고수준 모듈 의존 (인터페이스 구현)
- 인터페이스는 고수준 모듈과 저수준 모듈의 상충할 수 있는 방안

DIP 를 적용한 아키텍처는 도메인이나 응용 영역에 정의한 인터페이스를 상속받아 구현하는 구조가 되므로 도메인과 응용 영역에 대한 영향을 주지 않거나 최소화하면서 구현 기술을 변경하는 것이 가능하다.

> 추출한 추상화 인터페이스는 고수준 모듈에 속한다.

## 도메인 영역의 주요 구성요소

도메인 영역은 도메인의 핵심 모듈을 구현한다.

도메인 영역의 구성요소는 다음과 같다.

- [엔티티(Entity)](#엔티티와-밸류)
  - 고유한 식별자를 갖는 객체
  - 자신의 라이프사이클를 갖는다.
  - 도메인 모델의 데이터를 포함하며 해당 데이터와 관련된 기능을 함께 제공한다.
- [밸류(Value)]((#엔티티와-밸류))
  - 고유의 식별자를 갖지 않는 객체
  - 개념적으로 하나인 도메인의 객체의 속성을 표현할 때 사용한다.
- [애그리거트(Aggregate)](#애그리거트)
  - 애그리거트는 관련된 엔티티와 밸류 객체를 개념적으로 하나로 묶은 것이다.
- [리포지터리(Repository)](#리포지토리)
  - 도메인 모델의 영속성을 처리한다.
  - DBMS 테이블에서 엔티티 객체를 로딩하거나 저장하는 기능 제공
- 도메인 서비스(Domain Service)
  - 특정 엔티티에 속하지 않는 도메인 로직을 제공한다.
  - 다양한 조건을 이용해서 여러 도메인 로직을 가지고 구현하게 된다.

### 엔티티와 밸류

실제 도메인 모델의 엔티티와 DB 관계형 모델의 엔티티는 다르다.

- 가장 큰 차이점은 도메인 모델의 엔티티는 데이터와 함께 도메인 기능을 제공한다.
  - 도메인 지식을 담고 있는 객체
  - 단순히 데이터를 담고 있는 데이터 구조가 아니다.
  - 도메인 관점에서 기능을 구현하고 기능 구현을 캡슐화해서 데이터가 임의로 변경되는 것을 막는다.
- 도메인 모델의 엔티티는 두 개 이상의 데이터가 개념적으로 하나인 경우 밸류 타입을 이용해서 표현할 수 있다.
  - RDBMS와 같은 관계형 데이터베이스는 밸류 타입을 제대로 표현하기 어렵다.

### 애그리거트

도메인이 커질수록 도메인 모델도 커진다.

수 많은 엔티티와 밸류가 출현하기 때문에 모델은 점점 더 복잡해진다.

애그리거트는 도메인의 전체 구조의 이해를 돕기 위해, 도메인 모듈을 상위 수준에서 모델로 정의하여 관리한다. 상위 수준에서 모델을 볼 수 있어야 전체 모델의 관계와 개별 모델의 이해하는 데 도움이 된다.

- 애그리거트는 관련 객체를 하나로 묶은 군집으로 도메인의 상위 개념을 표현한다.
- 큰 틀에서 도메인 모델을 관리할 수 있다.

**에그리거트는 군집에 속한 객체들을 관리하는 루트 엔티티를 갖는다.**

`루트 엔티티`는 애그리거트에 속해 있는 엔티티와 밸류 객체를 이용해서 애그리거트가 구현해야할 기능 제공한다.

- 애그리거트가 제공하는 기능은 루트 엔티티를 통해서 접근한다.
- 루트 엔티티는 직/간접적으로 여러 하위 엔티티에 접근하게 된다.
  - 하위 엔티티의 기능의 내부 구현은 외부로부터 접근하지 못한다.
  - 애그리거트 단위로 구현을 캡슐화할 수 있도록 돕는다.

애그리거트를 구현할 때는 고려할 것이 많다.

- 구성에 따라 구현이 복잡해지기도 한다.
- 트랜잭션 범위가 달라지기도 한다.
- 선택한 구현 기술에 따라 애그리거트 구현에 제약이 생기기도 한다.

### 리포지토리

도메인 객체의 영속화를 위한 구성요소다.

- 도메인을 영속화하는 단위는 애그리거트의 루트 엔티티다.

저수준 모듈과 고수준 모듈로 나뉜다.

- 저수준 모듈: 도메인 관점에서 추출한 추상화 인터페이스, 도메인 영역에 속한다.
- 고수준 모듈: 추상화 인터페이스를 구현한 클래스, 인프라스트럭쳐 영역에 속한다.

응용 서비스와 리포지터리는 밀접한 연관이 있다.

- 응용 서비스는 필요한 도메인 객체를 구하거나 저장할 때 리포지터리를 사용한다.
- 응용 서비스는 트랜잭션을 관리하는데, 트랜잭션 처리는 리포지터리 구현 기술에 영향을 받는다.
- 리포지터리의 사용 주체가 응용 서비스다.
- 리포지터리는 응용 서비스가 필요로 하는 메서드를 제공한다.

리포지터리의 가장 기본이 되는 메서드는 다음과 같다.

- 애그리거트를 저장하는 메서드
- 애그리거트 루트 식별자로 애그리거트를 조회하는 메서드

## 요청 처리 흐름

![Start DDD!](/img/start-ddd/start-ddd_request_flow.png)

_출처 Start DDD!_

## 인프라스트럭처 개요

인프라스트럭처는 표현 영역, 응용 영역, 도메인 영역을 지원한다.

인프라스트럭처의 기능을 직접 사용하는 것보다 도메인 관점에서 정의한 인터페이스와 실제 구현하기 위한 인터페이스를 추출하여 관리하는게 DIP 설계를 도출하여 시스템을 더 유연하고 테스트하기 쉽게 만들어 줄 수 있다.

때론 인프라스트럭처의 기능을 직접 사용하는 것이 더 좋을 경우가 있다. 예를 들어 @Transactional 이다.

## 모듈 구성

아키텍처의 각 영역은 별도 패키지를에 위치한다.

- 계층 별 구분 방식
  - com.gmoon.ui
  - com.gmoon.application
  - com.gmoon.domain
  - com.gmoon.infra
- 도메인 별 구분 방식
  - com.gmoon.catalog
    - ui
    - application
    - domain
    - infra
  - com.gmoon.order
    - ui
    - application
    - domain
    - infra

모듈 구조를 얼마나 세분화해야 하는지에 대한 정해진 규칙은 없다. 

- 단지, 한 패키지에 너무 많은 타입이 몰려서 코드를 찾을 때 불편한 정도만 아니면 된다.
- 한 패키지에 가능하면 10개 미만의 타입 개수를 유지하도록 노력한다.
